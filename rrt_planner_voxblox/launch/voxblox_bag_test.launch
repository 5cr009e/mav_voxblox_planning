<?xml version="1.0" encoding="UTF-8"?>
<launch>
  <arg name="mav_name" default="jay"/>
  <arg name="namespace" default="$(arg mav_name)" />
  <arg name="bag" default="/home/helen/data/arche/2018_03_29_arche_test_1/flight_2.bag" />
  <arg name="stereo_params_camchain" default="$(find arche_maplab_utils)/params/day1_jay/camchain_p23022.yaml"/>
  <arg name="scale" default="0.5" />
  <arg name="process_every_nth_frame" default="5" />
  <arg name="play" default="true" />
  <param name="use_sim_time" value="true" />

  <node pkg="rosbag"  name="rosbag_play" type="play" output="screen" args="$(arg bag) -r 0.25 -s 20.0 --clock --pause" if="$(arg play)"/>
  <group ns="$(arg mav_name)">

  <node pkg="tf" type="static_transform_publisher" name="world_tf_broadcaster" args="0 0 0 0 0 0 1 world odom 10">
    <param name="capability_group" value="Core" />
  </node>

  <!-- <node pkg="tf" type="static_transform_publisher" name="cam0_cam1_broadcaster" args="0.1157    0.0001    0.0009   -0.0005   -0.0032   -0.0011    1.0000 camera0 cam1_rect 100">
    <param name="capability_group" value="Core" />
  </node>-->
  <node pkg="tf" type="static_transform_publisher" name="cam0_cam0_broadcaster" args="0 0 0 0 0 0 1 camera0 cam1 10">
    <param name="capability_group" value="Core" />
  </node>

  <node name="rovio" pkg="rovio" type="rovio_node" output="screen" clear_params="true">
    <param name="filter_config" value="$(find arche_maplab_utils)/params/day1_jay/rovio_filter_p23022.info" />
    <param name="camera0_config" value="$(find arche_maplab_utils)/params/day1_jay/rovio_equidist_cam0_p23022.yaml" />

    <param name="world_frame" value="odom"/>
    <param name="capability_group" value="Rovio" />
  </node>

  <node name="dense_stereo" pkg="image_undistort" type="dense_stereo_node" output="screen" >
    <param name="input_camera_info_from_ros_params" value = "true"/>
    <param name="first_camera_namespace" value="cam0"/>
    <param name="second_camera_namespace" value="cam1"/>
    <param name="first_output_frame" value="cam0"/>
    <param name="second_output_frame" value="cam1"/>
    <param name="scale" value="$(arg scale)"/>
    <param name="process_every_nth_frame" value="$(arg process_every_nth_frame)"/>

    <rosparam file="$(arg stereo_params_camchain)"/>

    <remap from="raw/first/image" to="cam0/image_raw"/>
    <remap from="raw/second/image" to="cam1/image_raw"/>
    <remap from="raw/first/camera_info" to="cam0/camera_info"/>
    <remap from="raw/second/camera_info" to="cam1/camera_info"/>

    <param name="capability_group" value="Planning" />
  </node>

  <node name="voxblox_node" pkg="voxblox_ros" type="esdf_server" output="screen" args="-alsologtostderr" clear_params="true">
    <remap from="pointcloud" to="dense_stereo/pointcloud"/>
    <param name="publish_tsdf_map" value="false" />
    <param name="tsdf_voxel_size" value="0.20" />
    <param name="tsdf_voxels_per_side" value="16" />
    <param name="voxel_carving_enabled" value="true" />
    <param name="color_mode" value="color" />
    <param name="use_tf_transforms" value="true" />
    <param name="update_mesh_every_n_sec" value="0.25" />
    <param name="max_ray_length_m" value="6.0" />
    <param name="slice_level" value="1.0" />
    <param name="publish_slices" value="true"/>
    <param name="publish_pointclouds" value="true"/>

    <param name="verbose" value="true" />
    <param name="use_freespace_pointcloud" value="false" />
    <param name="method" value="fast" />
    <param name="world_frame" value="odom" />
    <param name="publish_esdf_map" value="true" />
    <param name="publish_only_updated_blocks" value="true" />
    <remap from="voxblox_node/esdf_map_out" to="hello" />

    <param name="capability_group" value="Planning" />
  </node>

  </group>
</launch>
